+++
title = "内网穿透"
date = "2025-07-03"
description = "Tailscale教程：从公网轻松、安全地访问内网 Ubuntu 服务器"
author = "shihuaidexianyu"

[taxonomies]
+++

### **Tailscale教程：从公网轻松、安全地访问内网 Ubuntu 服务器**

本教程将指导您完成所有必要步骤，使用 Tailscale 为您的设备创建一个安全、私有的网络，让您无论身在何处，都能像在同一个局域网中一样，轻松访问您家或办公室的 Ubuntu 服务器。我们将涵盖从基础安装、常见问题排查、到解决与其他网络软件冲突的全部流程。

#### **第一部分：什么是 Tailscale，为什么选择它？**

简单来说，Tailscale 是一种现代化的 VPN（虚拟专用网络）服务。但与传统 VPN 不同，它极其简单，几乎无需配置。

**选择 Tailscale 的核心优势：**

  * **零配置，易于使用**：您无需拥有公网 IP，也无需在路由器上进行复杂的端口转发设置。
  * **高度安全**：它基于业界领先的 WireGuard® 协议构建，所有流量都经过端到端加密。
  * **打通一切**：一旦连接，所有网络服务（如 SSH、网站、文件共享、数据库）都将直接可用。
  * **跨平台支持**：支持 Windows, macOS, Linux, iOS, Android 等几乎所有主流操作系统。

本教程的目标是：将一台位于内网的 Ubuntu 服务器和一台位于公网的客户端设备连接到同一个 Tailscale 私有网络中，并实现无缝访问，同时确保它能与其他网络工具和平共处。

#### **第二部分：准备工作**

在开始之前，请确保您拥有：

1.  **一台内网 Ubuntu 服务器**：这是您希望从外部访问的目标设备。
2.  **一台客户端设备**：这是您用于发起远程访问的设备，例如您的笔记本电脑或手机。
3.  **一个 Tailscale 账户**：您可以使用现有的 Google, Microsoft, GitHub 或 Apple 账户在 [Tailscale 官网](https://tailscale.com/login) 免费注册。

#### **第三部分：核心安装与配置**

##### **步骤 1：在内网 Ubuntu 服务器上安装 Tailscale**

1.  登录您的 Ubuntu 服务器，打开终端。
2.  运行官方一键安装脚本。这个脚本会自动为您配置好软件源并安装 Tailscale。
    ```bash
    curl -fsSL https://tailscale.com/install.sh | sh
    ```
3.  启动 Tailscale 并授权设备。安装完成后，运行以下命令：
    ```bash
    sudo tailscale up
    ```
4.  在浏览器中验证。运行上述命令后，终端会显示一个用于验证的链接，类似：
    ```
    To authenticate, visit:

        https://login.tailscale.com/a/xxxxxxxxxxxx
    ```
    将此链接复制到任何设备的浏览器中打开，登录您的 Tailscale 账户，然后批准这台新的 Ubuntu 服务器加入您的网络。

##### **步骤 2：在客户端设备上安装 Tailscale**

1.  在您的客户端设备上，访问 [Tailscale 下载页面](https://tailscale.com/download)。
2.  下载并安装对应您操作系统的客户端（例如 Windows 或 macOS 版本）。
3.  安装后，启动 Tailscale 并**使用与上一步完全相同的账户**（Google, Microsoft 等）登录。

##### **步骤 3：验证连接与访问**

现在，您的两台设备都处于同一个名为 `Tailnet` 的私有网络中。每个设备都被分配了一个 `100.x.x.x` 格式的 IP 地址。您可以从客户端直接访问服务器了。

  * **通过 SSH 远程终端**（将 `ubuntu-server-name` 替换为其实际名称或 `100.x.x.x` IP）：
    ```bash
    ssh your_ubuntu_username@ubuntu-server-name
    ```
  * **访问 Web 服务**（如果服务器上运行了网站）：
    在客户端浏览器中输入 `http://ubuntu-server-name`

-----

#### **第四部分：故障排查、优化与冲突解决**

这是教程的关键部分，解决了您可能会遇到的常见问题和软件冲突。

##### **问题 1：感觉网速很慢怎么办？**

  * **诊断**：在客户端终端运行 `tailscale ping <服务器名>`，同时在另一个终端窗口运行 `tailscale status`。查看连接是 `direct` (直连) 还是 `relay` (中继)。
  * **解决方案**：
      * **如果是 `relay` (中继)**：检查服务器所在网络的路由器，尝试开启 **UPnP** 或 **NAT-PMP** 功能，以促成直连。
      * **如果是 `direct` (直连) 但依然慢**：检查您服务器所在网络的\*\*“上行带宽”\*\*，这决定了速度上限。同时，使用 `htop` 检查服务器的 CPU 占用率，排除性能瓶颈。

##### **问题 2：修复 Linux 上的 DNS 配置警告**

  * **问题**：运行 `tailscale status` 时看到 `# Health check: ... DNS config not ideal.` 的警告。
  * **原因**：系统上另一个程序正在与 Tailscale 争抢 DNS 控制权。
  * **解决方案**：运行以下命令，让 Tailscale “让出”对系统 DNS 的控制，这是解决所有 DNS 冲突的第一步。
    ```bash
    sudo tailscale up --accept-dns=false
    ```

##### **问题 3：解决与 v2rayA 等网络代理软件的冲突**

这是一个非常常见的进阶问题。当您同时使用 Tailscale 和 v2rayA、Clash 等代理软件时，它们可能会因为争抢系统路由和 DNS 的控制权而发生冲突。

  * **冲突根源**：v2rayA 等代理工具会尝试接管所有网络流量并发送到代理服务器，而 Tailscale 需要确保其私有网络（`100.x.x.x`）的流量走自己的加密通道。如果 Tailscale 的流量被错误地代理，连接就会失败。

  * **解决方案核心：分流（Split Tunneling）**
    我们的目标非常明确：**在代理软件中设置规则，让它忽略所有 Tailscale 和本地局域网的流量，使其“直连”**。

  * **具体配置步骤（以 v2rayA 为例）：**

    1.  **解决 DNS 冲突**：请务必先执行问题2中的命令，`sudo tailscale up --accept-dns=false`。这为后续操作打下基础。

    2.  **配置 v2rayA 路由规则**：

          * 登录 v2rayA 的 Web 管理界面（通常是 `http://127.0.0.1:2017`）。
          * 进入 **“设置” -\> “路由设置”** 或类似的分流配置页面。
          * 创建新的路由规则，动作为 **`direct` (直连)** 或 **`bypass` (绕过)**。
          * 在规则的目标地址中，**分条添加**以下 IP 地址段（CIDR）：
              * **`100.64.0.0/10`** **(最重要！这是 Tailscale 的地址空间)**
              * `192.168.0.0/16` (本地局域网)
              * `10.0.0.0/8`       (本地局域网)
              * `172.16.0.0/12`    (本地局域网)
              * `127.0.0.1/8`      (本机回环地址)

    3.  **保存并重启服务**：保存您的 v2rayA 规则，并最好按照 **先启动 Tailscale，再启动 v2rayA** 的顺序来运行服务。

  * **通用原则**：这个“分流”思想适用于所有代理软件。无论您使用什么工具，关键都是找到它的路由规则设置，并将上述的私有地址和 Tailscale 地址段加入到直连/绕过列表中。

-----

#### **第五部分：进阶功能简介**

  * **MagicDNS**：直接使用易记的设备名称代替 IP 地址进行访问。（非常好用的功能！！！不管是ssh还是网页服务）
  * **子网路由 (Subnet Routes)**：将 Ubuntu 服务器配置成一个网关，访问其所在局域网内的其他设备（如打印机、NAS）。
  * **访问控制 (ACLs)**：在管理后台定义精细的安全策略，例如“只允许我的笔记本电脑访问服务器的22端口”。
  * **Taildrop**：在您的各个 Tailscale 设备之间轻松、安全地传输文件。

#### **总结**

恭喜您！通过这份增强版教程，您不仅学会了如何搭建一个强大、安全的个人私有网络，还掌握了解决常见网络问题和软件冲突的关键技巧。现在，您可以更自信、更稳定地在任何网络环境下，随心所欲地访问您的个人服务器和网络资源。