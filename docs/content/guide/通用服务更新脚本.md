### é€šç”¨ Docker Compose æ›´æ–°è„šæœ¬

è¿™ä¸ªè„šæœ¬é€šè¿‡ `-d`ã€`-i` å’Œ `-n` æ ‡å¿—æ¥æ¥æ”¶**ç›®å½•è·¯å¾„**ã€**é•œåƒåç§°**å’Œ**æœåŠ¡åç§°**ã€‚

```bash
#!/bin/bash
# generic-compose-updater.sh
# A general-purpose script to update any Docker Compose service.

# --- Help and Usage Function ---
usage() {
  echo "Usage: $0 -d <compose_directory> -i <image_name> [-n <service_name>]"
  echo
  echo "This script automates the update process for a Docker Compose service."
  echo
  echo "Required Arguments:"
  echo "  -d    The absolute path to the directory containing the docker-compose.yml file."
  echo "  -i    The full name of the Docker image to pull and update (e.g., 'calciumion/new-api:latest')."
  echo
  echo "Optional Arguments:"
  echo "  -n    A friendly name for the service used in log messages. If not provided, it's derived from the image name."
  echo "  -h    Display this help message and exit."
  echo
  echo "Example:"
  echo "  $0 -d /home/user/services/new-api -i calciumion/new-api:latest -n new-api"
  exit 1
}

# --- Argument Parsing ---
COMPOSE_DIR=""
IMAGE_NAME=""
SERVICE_NAME=""

while getopts "d:i:n:h" opt; do
  case $opt in
    d) COMPOSE_DIR="$OPTARG" ;;
    i) IMAGE_NAME="$OPTARG" ;;
    n) SERVICE_NAME="$OPTARG" ;;
    h) usage ;;
    \?) usage ;;
  esac
done

# --- Validate Required Arguments ---
if [ -z "$COMPOSE_DIR" ] || [ -z "$IMAGE_NAME" ]; then
  echo "âŒ Error: Missing required arguments. Both directory (-d) and image name (-i) are required." >&2
  usage
fi

# If SERVICE_NAME is not provided, derive it from IMAGE_NAME
if [ -z "$SERVICE_NAME" ]; then
  # Extracts 'new-api' from 'user/new-api:latest' or 'nginx' from 'nginx:latest'
  SERVICE_NAME=$(echo "$IMAGE_NAME" | awk -F'/' '{print $NF}' | awk -F':' '{print $1}')
fi

# --- Script Body ---
echo "â–¶ï¸  Starting auto-update script for ${SERVICE_NAME}..."
echo "--------------------------------------------------"
echo "  Service Directory: $COMPOSE_DIR"
echo "  Image to Update:   $IMAGE_NAME"
echo "--------------------------------------------------"

# Step 1: Check if the configured directory exists.
if [ ! -d "$COMPOSE_DIR" ]; then
  echo "âŒ Error: Service directory not found: '$COMPOSE_DIR'"
  exit 1
fi

# Step 2: Attempt to pull the latest image.
echo -e "\n Pulling latest image: $IMAGE_NAME..."
output=$(docker pull "$IMAGE_NAME" 2>&1)

if [ $? -ne 0 ]; then
  echo "âŒ Error: Docker pull command failed."
  echo "$output"
  exit 1
fi

# Step 3: Check if the image is already up to date.
if echo "$output" | grep -q "Image is up to date"; then
  echo "âœ… Image is already up to date. No update needed."
  echo "--------------------------------------------------"
  echo "ğŸ‰ Script finished."
  exit 0
fi

echo "  Newer image detected, preparing to update..."

# Step 4: Apply the update using Docker Compose.
echo -e "\n Applying update via docker-compose..."
cd "$COMPOSE_DIR" || { echo "âŒ Error: Failed to change directory to '$COMPOSE_DIR'"; exit 1; }

docker compose up -d

if [ $? -ne 0 ]; then
  echo "âŒ Error: 'docker compose up -d' command failed."
  exit 1
fi

echo "âœ… ${SERVICE_NAME} service updated successfully!"

# (Optional) Print the new image version information.
version=$(docker inspect "$IMAGE_NAME" | grep 'org.opencontainers.image.version' | awk -F'"' '{print $4}')
if [ -n "$version" ]; then
  echo "  Current image version: $version"
fi

# Step 5: Clean up old, unused images.
echo -e "\n Cleaning up old images..."
docker image prune -f
echo "âœ… Old images cleaned up."
echo "--------------------------------------------------"
echo "ğŸ‰ Script completed on $(date)."
```

### å¦‚ä½•ä½¿ç”¨è¿™ä¸ªé€šç”¨è„šæœ¬

1.  **ä¿å­˜è„šæœ¬**: å°†ä¸Šé¢çš„ä»£ç ä¿å­˜ä¸ºä¸€ä¸ªæ–‡ä»¶ï¼Œä¾‹å¦‚ `update-service.sh`ã€‚
2.  **æˆäºˆæƒé™**: åœ¨ç»ˆç«¯ä¸­è¿è¡Œ `chmod +x update-service.sh`ï¼Œç»™è„šæœ¬æ‰§è¡Œæƒé™ã€‚
3.  **è¿è¡Œè„šæœ¬**: åœ¨è¿è¡Œæ—¶ï¼Œé€šè¿‡å‘½ä»¤è¡Œå‚æ•°å‘Šè¯‰å®ƒè¦æ›´æ–°å“ªä¸ªæœåŠ¡ã€‚

#### ç¤ºä¾‹1ï¼šæ›´æ–° `new-api`

```bash
./update-service.sh \
  -d "/path/to/your/new-api/compose/file" \
  -i "calciumion/new-api:latest" \
  -n "new-api"
```

#### ç¤ºä¾‹2ï¼šæ›´æ–° `LobeChat`

```bash
./update-service.sh \
  -d "/home/xianyu/services/lobe-chat-db" \
  -i "lobehub/lobe-chat-database:latest" \
  -n "LobeChat"
```

#### ç¤ºä¾‹3ï¼šæ›´æ–°ä¸€ä¸ª `Nginx` æœåŠ¡ï¼ˆ`-n` æ˜¯å¯é€‰çš„ï¼‰

å¦‚æœçœç•¥ `-n` å‚æ•°ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ä»é•œåƒåä¸­æå–ä¸€ä¸ªä½œä¸ºæœåŠ¡åã€‚

```bash
# åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒSERVICE_NAME ä¼šè‡ªåŠ¨å˜æˆ 'nginx'
./update-service.sh \
  -d "/path/to/your/nginx/service" \
  -i "nginx:latest"
```

#### è·å–å¸®åŠ©ä¿¡æ¯

å¦‚æœæ‚¨å¿˜è®°äº†å¦‚ä½•ä½¿ç”¨ï¼Œå¯ä»¥éšæ—¶è¿è¡Œ `-h` å‚æ•°æ¥æŸ¥çœ‹å¸®åŠ©ä¿¡æ¯ã€‚

```bash
./update-service.sh -h
```

é€šè¿‡è¿™ç§æ–¹å¼ï¼Œæ‚¨å°±æœ‰äº†ä¸€ä¸ªå¯ä»¥é‡å¤ä½¿ç”¨çš„å¼ºå¤§å·¥å…·ï¼Œé€‚ç”¨äºæ‚¨æœåŠ¡å™¨ä¸Šæ‰€æœ‰é€šè¿‡ Docker Compose éƒ¨ç½²çš„æœåŠ¡ã€‚

